# Save this file in: gateway/nginx.conf (REPLACE the old content)

server {
    listen 80;

    # This is a global setting. It tells our server to ALWAYS include the
    # permission slip on every response it sends. This is the most direct fix.
    add_header 'Access-Control-Allow-Origin' 'http://localhost:5173' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'Content-Type' always;

    # This handles the browser's initial security check (the "preflight" request).
    # If the browser is just asking for permissions, we give it a successful
    # "204 No Content" response immediately.
    if ($request_method = 'OPTIONS') {
        return 204;
    }

    # These are the routes to our backend agents. The permission slips above
    # will be applied to the responses from these agents as well.
    location /api/reflector {
        proxy_pass http://reflector-agent/analyze;
    }

    location /api/strategist {
        proxy_pass http://strategist-agent/analyze;
    }

    location /api/music {
        proxy_pass http://music-agent/analyze;
    }

    location /api/challenger {
        proxy_pass http://challenger-agent/synthesize;
    }
}